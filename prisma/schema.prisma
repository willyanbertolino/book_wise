generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Users Table
model User {
  id                    String             @id @db.Uuid()
  email                 String             @unique
  fullName              String             @map("full_name")
  role                  UserRole           @default(USER)
  subscriptionTier      SubscriptionTier   @default(FREE) @map("subscription_tier")
  subscriptionStatus    SubscriptionStatus @default(INACTIVE) @map("subscription_status")
  subscriptionStartDate DateTime?          @map("subscription_start_date")
  subscriptionEndDate   DateTime?          @map("subscription_end_date")
  stripeCustomerId      String?            @map("stripe_customer_id")
  stripeSubscriptionId  String?            @map("stripe_subscription_id")
  audioListenTime       Int                @default(0) @map("audio_listen_time")
  emailVerified         Boolean            @default(false) @map("email_verified")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  // Relations
  booksCreated        Book[]               @relation("BooksCreatedByUser")
  reviews             BookReview[]
  favorites           UserFavorite[]
  readingHistory      UserReadingHistory[]
  paymentTransactions PaymentTransaction[]
  subscriptionsOrders SubscriptionOrder[]
  adminActivityLogs   AdminActivityLog[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

enum SubscriptionTier {
  FREE
  MONTHLY
  YEARLY
  LIFETIME
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  CANCELLED
}

model Category {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  slug         String   @unique
  description  String?
  icon         String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  books Book[]

  @@map("categories")
}

model Book {
  id                 Int      @id @default(autoincrement())
  title              String
  slug               String   @unique
  author             String
  categoryId         Int      @map("category_id")
  description        String?
  coverImageUrl      String?  @map("cover_image_url")
  originalPdfUrl     String?  @map("original_pdf_url")
  originalPdfPath    String?  @map("original_pdf_path")
  publicationYear    Int?     @map("publication_year")
  isbn               String?
  readingTimeMinutes Int      @default(15) @map("reading_time_minutes")
  totalAudioDuration Int      @default(0) @map("total_audio_duration")
  averageRating      Decimal  @default(0) @map("average_rating") @db.Decimal(3, 2)
  totalReviews       Int      @default(0) @map("total_reviews")
  viewCount          Int      @default(0) @map("view_count")
  isFeatured         Boolean  @default(false) @map("is_featured")
  isPublished        Boolean  @default(false) @map("is_published")
  isSummaryGenerated Boolean  @default(false) @map("is_summary_generated")
  isAudioGenerated   Boolean  @default(false) @map("is_audio_generated")
  createdById        String   @map("created_by") @db.Uuid()
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  category       Category             @relation(fields: [categoryId], references: [id])
  createdBy      User                 @relation("BooksCreatedByUser", fields: [createdById], references: [id])
  summary        BookSummary?
  chapters       BookChapter[]
  reviews        BookReview[]
  favorites      UserFavorite[]
  readingHistory UserReadingHistory[]

  @@index([isPublished, categoryId])
  @@index([isPublished, isFeatured])
  @@index([categoryId])
  @@index([createdById])
  @@index([slug])
  @@map("books")
}

model BookSummary {
  id              Int      @id @default(autoincrement())
  bookId          Int      @unique @map("book_id")
  mainSummary     String?  @map("main_summary")
  keyTakeaways    Json?    @map("key_takeaways")
  fullSummary     String?  @map("full_summary")
  tableOfContents Json?    @map("table_of_contents")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@map("book_summaries")
}

model BookChapter {
  id             Int      @id @default(autoincrement())
  bookId         Int      @map("book_id")
  chapterNumber  Int      @map("chapter_number")
  chapterTitle   String   @map("chapter_title")
  chapterSummary String   @map("chapter_summary")
  audioUrl       String?  @map("audio_url")
  audioDuration  Int      @default(0) @map("audio_duration")
  displayOrder   Int      @default(0) @map("display_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // relations
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId, chapterNumber])
  @@map("book_chapters")
}

model BookReview {
  id                 Int      @id @default(autoincrement())
  bookId             Int      @map("book_id")
  userId             String   @map("user_id") @db.Uuid()
  rating             Int
  reviewTitle        String?  @map("review_title")
  reviewText         String?  @map("review_text")
  isPurchaseVerified Boolean  @default(false) @map("is_purchase_verified")
  isApproved         Boolean  @default(true) @map("is_approved")
  helpfulCount       Int      @default(0) @map("helpful_count")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@index([bookId, createdAt])
  @@index([userId])
  @@map("book_reviews")
}

model UserFavorite {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id") @db.Uuid()
  bookId    Int      @map("book_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@index([bookId])
  @@index([userId])
  @@map("user_favorites")
}

model UserReadingHistory {
  id                   Int      @id @default(autoincrement())
  userId               String   @map("user_id") @db.Uuid()
  bookId               Int      @map("book_id")
  lastAccessed         DateTime @default(now()) @map("last_accessed")
  completionPercentage Int      @default(0) @map("completion_percentage")
  audioPosition        Int      @default(0) @map("audio_position")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@index([userId, lastAccessed])
  @@index([bookId])
  @@index([userId])
  @@map("user_reading_history")
}

model SubscriptionPlan {
  id            Int      @id @default(autoincrement())
  planName      String   @unique @map("plan_name")
  planType      PlanType @map("plan_type")
  price         Decimal  @db.Decimal(10, 2)
  features      Json?
  stripePriceId String?  @map("stripe_price_id")
  isActive      Boolean  @default(true) @map("is_active")
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("subscription_plans")
}

enum PlanType {
  MONTHLY
  YEARLY
  LIFETIME
}

model PaymentTransaction {
  id                    Int           @id @default(autoincrement())
  userId                String        @map("user_id") @db.Uuid()
  stripePaymentIntentId String?       @unique @map("stripe_payment_intent_id")
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("USD")
  paymentStatus         PaymentStatus @map("payment_status")
  planType              PlanType      @map("plan_type")
  metadata              Json?
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("payment_transactions")
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

model SubscriptionOrder {
  id                   Int         @id @default(autoincrement())
  userId               String      @map("user_id") @db.Uuid()
  planType             PlanType    @map("plan_type")
  amount               Decimal     @db.Decimal(10, 2)
  currency             String      @default("USD")
  paymentMethod        String      @default("BANK_TRANSFER") @map("payment_method")
  paymentProofUrl      String?     @map("payment_proof_url")
  transactionReference String?     @map("transaction_reference")
  orderStatus          OrderStatus @default(PENDING) @map("order_status")
  approvedBy           String?     @map("approved_by")
  approvedAt           DateTime?   @map("approved_at")
  rejectedReason       String?     @map("rejected_reason")
  notes                String?
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderStatus])
  @@map("subscription_orders")
}

enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model AdminActivityLog {
  id          Int      @id @default(autoincrement())
  adminId     String   @map("admin_id") @db.Uuid()
  actionType  String   @map("action_type")
  targetType  String   @map("target_type")
  targetId    Int?     @map("target_id")
  description String?
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  admin User @relation(fields: [adminId], references: [id])

  @@index([targetType, targetId])
  @@index([adminId])
  @@map("admin_activity_logs")
}
